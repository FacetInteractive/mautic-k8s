# upstream mautic {
#   server 127.0.0.1:9000;
# }

server {
    server_name ${SERVER_NAME};
    root /var/www/symfony/mautic;
    # listen 0.0.0.0:8080 proxy_protocol;
    listen 0.0.0.0:8080;
    # set_real_ip_from 10.0.0.0/8;
    # real_ip_header proxy_protocol;

    # proxy_set_header    X-Real-IP           $proxy_protocol_addr;
    # proxy_set_header    X-Forwarded-For     $proxy_protocol_addr;


    # log_format main '$proxy_protocol_addr - $remote_user [$time_local] '
    #                '"$request" $status $body_bytes_sent '
    #                '"$http_referer" "$http_user_agent"';

    # add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since';
    # add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';

    # resolver 8.8.8.8;
    # resolver_timeout 5s;
    # add_header Strict-Transport-Security 'max-age=63072000; includeSubDomains; preload' always;

    # add_header X-Forwarded-For $http_x_forwarded_for;

    gzip on;
    gzip_disable "msie6";
    gzip_min_length 256;

    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types
        font/truetype
        font/opentype
        font/woff2
        text/plain
        text/css
        text/js
        text/xml
        text/javascript
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/rss+xml
        image/svg+xml;

    # error_page 404 /index.php;

    # redirect index.php to root
    # rewrite ^/index.php/(.*) /$1 permanent;

    rewrite ^/(vendor|translations|build)/.* /index.php break;
    
    location / {
         try_files $uri /index.php$is_args$args;

         # proxy_set_header        Host                $host;
         # proxy_set_header        X-Real-IP           $proxy_protocol_addr;
         # proxy_set_header        X-Forwarded-For     $proxy_protocol_addr;
         # proxy_set_header        X-Forwarded-Proto   $scheme;

         # drop unused proxy headers to prevent clients from tampering with them
         # proxy_set_header        X-Forwarded-Port   "";
         # proxy_set_header        Forwarded   "";
         # proxy_set_header        X-Real-IP   "";
         # proxy_set_header        X-Forwarded-Host "";

         # @TODO - What goes here?
         # proxy_pass http://mautic;
    }

    # Deny everything else in /app folder except Assets folder in bundles
    location ~ /app/bundles/.*/Assets/ {
        allow all;
        access_log off;
    }
    location ~ /app/ { deny all; }

    # Deny everything else in /addons or /plugins folder except Assets folder in bundles
    location ~ /(addons|plugins)/.*/Assets/ {
        allow all;
        access_log off;
    }

    # Deny all php files in themes folder
    location ~* ^/themes/(.*)\.php {
        deny all;
    }

    # Don't log favicon
    location = /favicon.ico {
    	log_not_found off;
    	access_log off;
    }

    # Don't log robots
    location = /robots.txt  {
    	access_log off;
    	log_not_found off;
    }

    # Deny yml, twig, markdown, init file access
    location ~* /(.*)\.(?:markdown|md|twig|yaml|yml|ht|htaccess|ini)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny all attempts to access hidden files/folders such as .htaccess, .htpasswd, .DS_Store (Mac), etc...
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny all grunt, composer files
    location ~* (Gruntfile|package|composer)\.(js|json)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~*  \.(jpg|jpeg|png|ico|pdf)$ {
        expires 15d;
    }

    # Deny access to any files with a .php extension in the uploads directory
    location ~* /(?:uploads|files)/.*\.php$ {
        deny all;
    }

    # Solve email tracking pixel not found
    location ~ email/(.*).gif {
        try_files $uri /index.php?$args;
    }

    # Solve JS Loading 404 Error
    location ~ (.*).js {
        try_files $uri /index.php?$args;
    }

    location ~ /.well-known {
        allow all;
    }

    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        # fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTPS off;
    }

}
