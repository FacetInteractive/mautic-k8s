name: mautic
recipe: lemp
config:
  webroot: mautic
  php: '7.2'
  database: mysql:5.7
  xdebug: true
  config:
    vhosts: nginx-mautic.conf
# Copy from .env.lando.dist to .env
env_file:
  - .env

# Set a reachable management site ( User: guest, Pass: guest )
proxy:
  rabbitmq:
    - rabbit.lndo.site:15672

services:
  # Mautic Appserver
  appserver:
    build:
      - "cd /app/mautic && composer install"
    overrides:
      environment:
        PHP_IDE_CONFIG: "serverName=mautic.lndo.site"
        # Other Environment variables included via .env
    build_as_root:
      - "cd / && mkdir cache && chown -R www-data:dialout /cache && chmod -R g+rwX /cache"
      - "cd / && mkdir logs && chown -R www-data:dialout /logs && chmod -R g+rwX /logs"
      - "apt-get update -y"
      - "apt-get install -y libmcrypt-dev"
      - "apt-get install -y zlib1g-dev"
      - "apt-get install -y libwebp-dev"
      - "apt-get install -y libjpeg62-turbo-dev"
      - "apt-get install -y libpng-dev"
      - "apt-get install -y libxpm-dev"
      - "apt-get install -y libfreetype6-dev"
      - "pecl install mcrypt-1.0.1 -y"
      - "docker-php-ext-enable imap pdo pdo_mysql mcrypt bcmath zip redis"
      - "docker-php-ext-configure gd --with-gd --with-webp-dir --with-jpeg-dir --with-png-dir --with-zlib-dir --with-xpm-dir --with-freetype-dir"
      - "docker-php-ext-install gd"
  # Setup RabbitMQ service using "compose"
  rabbitmq:
    type: compose
    services:
      # Grab RabbitMQ management image
      image: "rabbitmq:3-management"
      hostname: "rabbit"

      # Start the server for RabbitMQ
      command: rabbitmq-server

      # Expose RabbitMQ Ports
      ports:
        - '15672:15672'
        - '5672:5672'

      # Link RabbitMQ Configs
      volumes:
        - rabbitmq-isolated.conf:/etc/rabbitmq/rabbitmq.config
      labels:
        NAME: "rabbitmq"

tooling:
  php:
    service: appserver
    cmd: php
  segment-update:
    service: appserver
    cmd: php /app/mautic/app/console mautic:segments:update
  campaigns-update:
    service: appserver
    cmd: php /app/mautic/app/console mautic:campaigns:update
  campaigns-trigger:
    service: appserver
    cmd: php /app/mautic/app/console mautic:campaigns:trigger
  hubspot-push:
    service: appserver
    cmd: php /app/mautic/app/console mautic:integration:pushleadactivity --integration=Hubspot
  hubspot-fetch:
    service: appserver
    cmd: php /app/mautic/app/console mautic:integration:fetchleads --integration=Hubspot
  phpunit:
    service: appserver
    cmd: /app/mautic/bin/phpunit
  test:
    service: appserver
    description: Run Tests Locally
    cmd:
      - appserver: composer test
  # Set up command "Lando rabbit" for basic RabbitMQ commands
  rabbit:
    service: rabbitmq
    # User must be root to prevent erlang cookie error
    user: root
    cmd: rabbitmqctl
  # Setup command "lando rabbit-ip" to get the ip address
  rabbit-ip:
    service: rabbitmq
    cmd:
      - echo -e "\n\e[36mRABBITMQ IP ADDRESS:\e[32m"
      - hostname -i | cut -d' ' -f1

events:
  # Shows IP address on 'lando start'
  post-start:
    - rabbitmq: echo -e "\n\e[36mRABBITMQ IP ADDRESS:\e[32m"
    - rabbitmq: hostname -i | cut -d' ' -f1